<html>
<head>

<style>

  body {
    font-family: arial;
  }

  table, th, td {
    border: 1px solid;
    border-collapse: collapse;
    padding: 10px;
  }

</style>

</head>
<body>

<h1>Settings</h1>

<form method="post" action="">

<?php

function testCredentials() {
  $connection = ssh2_connect($sshHost, $sshPort);
  ssh2_auth_password($connection, $sshUser, $sshPass);
  $ssh_stream = ssh2_exec($connection, "hostname");
  stream_set_blocking($ssh_stream, true);
  while ($f = fgets($ssh_stream)) {
    echo "<p>Connection to $f successful</p>";
  }
  fclose($ssh_stream);
}

// READ AND SET VARS OF CURRENT SETTINGS
    $settingsFilePath = "settings.json";
    $settingsFile = fopen($settingsFilePath, "r");
    $currentSettings = json_decode(fread($settingsFile, filesize($settingsFilePath)), true);
    fclose($settingsFile);
//    var_dump($currentSettings);
    $mode = $currentSettings["mode"];
    $sshHost = $currentSettings["sshHost"];
    $sshPort = $currentSettings["sshPort"];
    $sshUser = $currentSettings["sshUser"];
    $sshPass = $currentSettings["sshPass"];
?>
  <br>
  <hr>
  <table>
    <tr>
      <th>Setting</th>
      <th>Existing Value</th>
      <th>New Setting</th>
    </tr>
    <tr>
      <td>Mode</td>
      <td><?php echo $mode; ?></td>
      <td>
        <input type="radio" id="local" name="mode" value="local">
        <label for="local"> Local</label><br>
        <input type="radio" id="remote" name="mode" value="remote">
        <label for="remote"> Remote</label>
      </td>
    </tr>
    <tr>
      <td><label for="sshHost">SSH Host </label></td>
      <td><?php echo $sshHost; ?> </td>
      <td><input type="text" id="sshHost" name="sshHost" value="" ></td>
    </tr>
    <tr>
      <td><label for="sshPort">SSH Port</label></td>
      <td><?php echo $sshPort; ?></td>
      <td><input type="text" id="sshPort" name="sshPort" value="" pattern="\d+"></td>
    </tr>
    <tr>
      <td><label for="sshUser">SSH Username </label></td>
      <td><?php echo $sshUser; ?> </td>
      <td><input type="text" id="sshUser" name="sshUser" value=""></td>
    </tr>
    <tr>
      <td><label for="sshPass">SSH Password</label></td>
      <td><?php echo $sshPass; ?> </td>
      <td><input type="text" id="sshPass" name="sshPass" value=""></td>
    </tr>
    <tr>
      <td colspan="3"><p>Password is stored unencrypted, lab use only, do not enter production passwords</p></td>
    </tr>
    <tr>
      <td colspan="3">
        <input type="hidden" name="update" value="update">
        <input type="submit" name="submit" value="Save">
      </td>
    </tr>
  </table>




</form>

<?php

// GRAB UPDATED VALUES FROM NEW SAVE

$mode = $_POST['mode'];
$sshHost = $_POST['sshHost'];
$sshPort = $_POST['sshPort'];
$sshUser = $_POST['sshUser'];
$sshPass = $_POST['sshPass'];
$update = $_POST['update'];

// CREATE JSON

$newSettings = json_encode(array('mode' => $mode, 'sshHost' => $sshHost, 'sshPort' => $sshPort, 'sshUser' => $sshUser, 'sshPass' => $sshPass), JSON_PRETTY_PRINT);

// SAVE NEW SETTINGS
// FIRST CHECK FOR $update INDICATES FORM HAS BEEN SUBMITTED, PREVENTS OVERWRITE ON PAGE LAUNCH

if ($update) {
   $settingsFile = fopen($settingsFilePath, "w+");   
   $settingsArray = fwrite($settingsFile, $newSettings);  
   fclose($settingsFile);
   echo "<p><b>Saved Settings</b></p>";
   print_r($newSettings);
   header("Refresh:0");
}

?>

</body>
</html>
